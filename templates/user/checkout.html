{% load static %}
{% load user_extras %}
<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>订单确认</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link rel="stylesheet" href="{% static 'user/css/all.css' %}" />
    <link rel="stylesheet" href="{% static 'user/css/checkout.css' %}" />

    <script src="http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <style>
        table td {
            vertical-align: middle !important;
        }
    </style>
</head>

<body>
    <!-- 导航栏 -->
    {% show_nav_part %}

    <!--主体内容-->
    <div class="container" style="margin-top: 60px; ">
        <div class="container-fluid">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}
        </div>
        <div class="row">
            <div class="col-sm-12">
                <h3 class="title">确认收货地址</h3>
                <hr>
                <ul class="list-address">
                    <li class="col-sm-3" id="address-1111" onclick="choseAddress(this)">
                        <h4>姓名</h4>
                        <div style="padding-top: 5px">
                            <p>址详细地址详细地址详细地址详细地址详细地址详细地址</p>
                            <p>15027100106</p>
                        </div>
                    </li>
                    <li class="col-sm-3 active" id="address-1112" onclick="choseAddress(this)">
                        <h4>姓名</h4>
                        <div style="padding-top: 5px">
                            <p>址详细地址详细地址详细地址详细地址详细地址详细地址</p>
                            <p>15027100106</p>
                        </div>
                    </li>
                    <li class="col-sm-3" id="address-1113" onclick="choseAddress(this)">
                        <h4>姓名</h4>
                        <div style="padding-top: 5px">
                            <p>址详细地址详细地址详细地址详细地址详细地址详细地址</p>
                            <p>15027100106</p>
                        </div>
                    </li>
                    <li class="col-sm-3" id="address-1114" onclick="choseAddress(this)">
                        <h4>姓名</h4>
                        <div style="padding-top: 5px">
                            <p>址详细地址详细地址详细地址详细地址详细地址详细地址</p>
                            <p>15027100106</p>
                        </div>
                    </li>
                    <li class="col-sm-3" id="address-1114" onclick="choseAddress(this)">
                        <h4>姓名</h4>
                        <div style="padding-top: 5px">
                            <p>址详细地址详细地址详细地址详细地址详细地址详细地址</p>
                            <p>15027100106</p>
                        </div>
                    </li>
                </ul>
            </div>
            <hr>

            <!-- 商品页面的表格 -->
            <div class="col-sm-12" style="margin-top: 30px">
                <h3 class="title">确认商品信息</h3>
                <hr>
                <table class="table" style="margin-top: 10px;" id="confirm-table">
                    <tbody>
                        <tr>
                            <th>商店名</th>
                            <th colspan="3">商品信息</th>
                            <th>单价</th>
                            <th>数量</th>
                            <th>优惠</th>
                            <th>小计</th>
                        </tr>
                        {% for name,order in order_list.items %}

                            {% for pro in order %}
                            <tr>
                                <td>{{ name }}</td>
                                <td width="10%">
                                    <img src="/static/{{ pro.image }}" alt="">
                                </td>
                                <td width="10%">{{ pro.product_name }}</td>
                                <td width="30%">{{ pro.desc }}</td>
                                <td width="10%">￥<span>{{ pro.product_price }}</span> </td>
                                <td width="10%" class="unit-count">{{ pro.product_number }}</td>
                                <td width="10%">
                                    {% if pro.discount %}
                                        -￥{{ pro.discount }}
                                    {% else %}
                                        无
                                    {% endif %}
                                </td>
                                <td width="10%">￥<span class="subtotal">
                                    {{ pro.distp }}
                                </span></td>
                            </tr>
                            {% endfor %}

                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-4 col-md-offset-8" style="text-align: right;">
                共有<span id="total-count" style="color: #f71117 ">{{ product_number }}</span>件商品，共计：
                <span id="total-price" style="color: #f71117;font-size: 1.2em;">{{ total_price }}</span>元
                <button class="btn btn-success btn-lg" onclick="checkout()">确认付款</button>
            </div>
        </div>
    </div>
    <!-- 页脚 -->
    {% show_footer %}


</body>

<script type="text/javascript">
    //打开窗口时自动生成
    $(document).ready(function () {
        //要执行的js代码段
        loadAddresses();
    });

    //选择地址的函数
    function choseAddress(li) {
        let theLi = $(li);
        theLi.addClass("active");
        theLi.siblings().removeClass("active");
    }

    //获得个数和总计
    function getTotal() {
        let tbody = $("#confirm-table tbody");
        let totalCount = 0;
        let totalPrice = 0;
        tbody.children().each(function (i, tr) {
            let theTr = $(tr);

            if (i != 0) {//i=0是标题栏
                let countTd = theTr.find(".unit-count");
                let subTotalSpan = theTr.find(".subtotal");

                totalCount += parseInt(countTd.text());
                totalPrice += parseFloat(subTotalSpan.text());
            }
        });

        $("#total-count").text(totalCount);
        $("#total-price").text(totalPrice.toFixed(2));
    }

    var addresses = {{ addresses }};
    console.log(addresses);

    var addressList = [{
        id: 1234564876,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    {
        id: 123456487,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    {
        id: 12345648,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    {
        id: 1234564,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    {
        id: 123456,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    {
        id: 12347,
        receiver: "qqq",
        address: "详细地址详细地址详细地址详细地址",
        tel: "11122223333"
    },
    ];

    var orderList = [{
        id: 1234564876,
        imageURL: "../images/index/4.jpg",
        goodName: "商品名",
        goodDescrip: "商品描述商品描述商品描述商品描述商品描述商品描述",
        unitPrice: 59,
        goodCount: 1,
        disCount: 5,
        subtotal: 54
    },
    {
        id: 1234564876,
        imageURL: "../images/index/4.jpg",
        goodName: "商品名",
        goodDescrip: "商品描述商品描述商品描述商品描述商品描述商品描述",
        unitPrice: 59,
        goodCount: 1,
        disCount: 5,
        subtotal: 54
    },
    {
        id: 1234564876,
        imageURL: "../images/index/4.jpg",
        goodName: "商品名",
        goodDescrip: "商品描述商品描述商品描述商品描述商品描述商品描述",
        unitPrice: 59,
        goodCount: 1,
        disCount: 5,
        subtotal: 54
    },
    {
        id: 1234564876,
        imageURL: "../images/index/4.jpg",
        goodName: "商品名",
        goodDescrip: "商品描述商品描述商品描述商品描述商品描述商品描述",
        unitPrice: 59,
        goodCount: 2,
        disCount: 5,
        subtotal: 113
    },
    ];

    function loadAddresses() {

        let addressUl = $(".list-address");
        addressUl.html("");
        $.each(addresses, function (i, item) {
            let addressLi = document.createElement("li");
            addressLi.setAttribute("class", "col-sm-3");
            if (i == 0) {
                addressLi.setAttribute("class", "col-sm-3 active");
            }
            addressLi.setAttribute("onclick", "choseAddress(this)");
            addressLi.id = "address-" + item.pk;
            addressUl.append(addressLi);

            let receiverH4 = document.createElement("h4");
            receiverH4.innerHTML = item.fields.receiver;
            addressLi.append(receiverH4);

            let addressDetailDiv = document.createElement("div");
            addressDetailDiv.setAttribute("style", "padding-top:5px");
            addressDetailDiv.innerHTML = "<p>" + item.fields.address + "</p><p>" + item.fields.receive_phone + "</p>";
            addressLi.append(addressDetailDiv);
        });


    }

    function loadOrders() {

        let tbody = $("#confirm-table tbody");
        tbody.html("");
        /* alert("wdnmd"); */
        let headerTr = document.createElement("tr");
        headerTr.innerHTML = " <th colspan=\"3\">商品信息</th><th>单价</th><th>数量</th><th>优惠</th><th>小计</th>";
        tbody.append(headerTr);
        $.each(orderList, function (i, item) {
            let orderTr = document.createElement("tr");
            tbody.append(orderTr);

            let imageTd = document.createElement("td");
            imageTd.setAttribute("width", "10%");
            orderTr.append(imageTd);

            let image = document.createElement("img");
            image.src = item.imageURL;
            imageTd.append(image);

            let goodNameTd = document.createElement("td");
            goodNameTd.setAttribute("width", "10%");
            goodNameTd.innerHTML = item.goodName;
            orderTr.append(goodNameTd);

            let goodDescripTd = document.createElement("td");
            goodDescripTd.setAttribute("width", "40%");
            goodDescripTd.innerHTML = item.goodDescrip;
            orderTr.append(goodDescripTd);

            let unitPriceTd = document.createElement("td");
            unitPriceTd.setAttribute("width", "10%");
            unitPriceTd.innerHTML = "￥" + item.unitPrice.toFixed(2);
            orderTr.append(unitPriceTd);

            let countTd = document.createElement("td");
            countTd.setAttribute("class", "unit-count");
            countTd.setAttribute("width", "10%");
            countTd.innerHTML = item.goodCount;
            orderTr.append(countTd);

            let discountTd = document.createElement("td");
            discountTd.setAttribute("width", "10%");
            if (item.disCount == 0) {
                discountTd.innerHTML = "无";
            } else {
                discountTd.innerHTML = "-￥" + item.disCount.toFixed(2);
            }
            orderTr.append(discountTd);

            let subtotalTd = document.createElement("td");
            subtotalTd.setAttribute("width", "10%");
            subtotalTd.innerHTML = "￥" + "<span class=\"subtotal\">" + item.subtotal.toFixed(2) + "</span>";
            orderTr.append(subtotalTd);
        });

        getTotal();
    }

    //点击结算，返回地址的id，是字符串形式
    function checkout() {
        //address-1231
        let addressIdStr = $(".list-address").children(".active").attr("id");
        //address-1234 -> 1234
        let addressId = addressIdStr.substring(8);
        //alert(addressId);
        //window.open("finish_order.html", "_self");

        $.ajax({
            type: "POST",
            url: "/checkout/",
            data: {
                address_id: addressId
            },
            dataType: "json",
            success: function (result) {
                console.log("success")
                if (result.status == 'success') {
                    window.open('/place_order_success/');
                }
            },
            error: function (result) {
                console.log("error")
                //window.location.href("index.html");
            },
        })

    }
</script>

</html>